<!DOCTYPE html>
<html lang="en">
<head>
  <!--
    Andoru Shinkai â€” Deep Sea Chat (Premium)
    Single-file, production-polished index.html with:
    - Firebase Realtime Database messaging (timestamps, read receipts)
    - Typing indicator
    - Emoji picker, GIF search, stickers
    - Desktop notifications
    - Mobile-optimized full-screen layout
    - Floating chat bubble (PC)
    - Anime deep-sea theme + companion dialogue
    - Accessibility and performance-minded structure

    How to use:
    1) Replace the Firebase config in the script with your keys.
    2) If you want GIFs, add your GIPHY API key in GIF section.
    3) Place an image at /assets/anime-girl.png or update src below.
    4) Host as-is on Namecheap/GitHub Pages/Firebase Hosting.
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Andoru Shinkai â€¢ Deep Sea Chat</title>
  <meta name="theme-color" content="#001f3f">
  <meta name="description" content="A magical deep-sea anime chat overlay for Andoru Shinkai." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Sawarabi+Mincho&display=swap" rel="stylesheet">

  <!-- Emoji Picker (emoji-mart v5 web) -->
  <link rel="preload" href="https://unpkg.com/emoji-mart@5.6.0/dist/browser.js" as="script" />
  <script src="https://unpkg.com/emoji-mart@5.6.0/dist/browser.js" defer></script>

  <!-- Firebase v10 (Modular SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js" defer></script>

  <style>
    :root {
      /* Deep sea palette */
      --sea-0: #0a1a2f;
      --sea-1: #001f3f;
      --sea-2: #003366;
      --accent: #00bcd4;
      --accent-2: #26c6da;
      --text: #e0f7fa;
      --muted: #9ddde6;
      --danger: #ef4444;
      --success: #22c55e;

      /* Sizing */
      --radius: 14px;
      --pad: 12px;

      /* Shadow glow */
      --glow: 0 0 22px rgba(0, 188, 212, 0.55);
      --inner-glow: inset 0 0 18px rgba(38, 198, 218, 0.2);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 70% 10%, #02223e 0%, #00162c 45%, #000a18 100%);
      color: var(--text);
      font-family: 'Kosugi Maru', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      overflow-x: hidden;
    }

    /* Ocean particles backdrop */
    canvas#sea-particles {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      opacity: 0.35;
    }

    /* Floating companion anime girl */
    #companion {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 170px;
      z-index: 2;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,0.35));
      animation: floatY 6s ease-in-out infinite;
    }
    @keyframes floatY {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    /* Companion speech bubble */
    .companion-dialogue {
      position: fixed;
      bottom: 200px;
      left: 44px;
      z-index: 3;
      background: linear-gradient(180deg, rgba(0,31,63,0.92), rgba(0,51,102,0.92));
      border: 1px solid rgba(0,188,212,0.4);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 12px;
      box-shadow: var(--glow);
      font-size: 14px;
      max-width: 220px;
      animation: bubbleFade 4s ease-in-out both;
    }
    @keyframes bubbleFade {
      0% { opacity: 0; transform: translateY(4px); }
      12% { opacity: 1; transform: translateY(0); }
      85% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-4px); }
    }

    /* Chat bubble (minimized) */
    #chat-bubble {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 4;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: radial-gradient(120px 120px at 40% 40%, var(--accent-2), var(--accent));
      color: #00243f;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--glow);
      border: 2px solid rgba(255,255,255,0.15);
      cursor: pointer;
      user-select: none;
    }
    #chat-bubble:hover { filter: brightness(1.08); }

    /* Main chat panel */
    #chat-box {
      position: fixed;
      bottom: 90px;
      right: 20px;
      z-index: 4;
      width: 360px;
      height: 520px;
      border-radius: var(--radius);
      display: grid;
      grid-template-rows: auto 1fr auto;
      background: linear-gradient(180deg, var(--sea-0), var(--sea-1), var(--sea-2));
      border: 2px solid rgba(255,255,255,0.08);
      box-shadow: var(--glow);
      overflow: hidden;
      transform-origin: bottom right;
    }
    #chat-box.hidden { display: none; }

    /* Header */
    .chat-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px var(--pad);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: rgba(0, 31, 63, 0.55);
      backdrop-filter: blur(4px);
    }
    .room-title {
      font-family: 'Sawarabi Mincho', serif;
      letter-spacing: 0.5px;
      font-size: 18px;
    }
    .presence {
      margin-left: auto;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .presence .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px rgba(34,197,94,0.8);
    }

    /* Messages area */
    #messages {
      position: relative;
      padding: var(--pad);
      overflow-y: auto;
      background: linear-gradient(180deg, rgba(0,31,63,0.35), rgba(0,51,102,0.28));
    }
    .msg {
      max-width: 84%;
      margin: 8px 0;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0, 43, 92, 0.7);
      border: 1px solid rgba(0,188,212,0.25);
      box-shadow: var(--inner-glow);
      word-wrap: break-word;
      line-height: 1.35;
      font-size: 14.5px;
    }
    .msg.me {
      margin-left: auto;
      background: rgba(0, 188, 212, 0.18);
      border-color: rgba(0,188,212,0.35);
    }
    .meta {
      display: flex;
      gap: 8px;
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
      align-items: center;
    }
    .meta .status-read { color: var(--success); }
    .meta .status-unread { color: #fbbf24; }

    /* Typing indicator */
    .typing {
      position: absolute;
      bottom: 8px;
      left: var(--pad);
      display: none;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
      padding: 6px 10px;
      background: rgba(0,31,63,0.5);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 999px;
      backdrop-filter: blur(3px);
    }
    .typing.show { display: inline-flex; }
    .typing .dots { display: inline-flex; gap: 3px; }
    .typing .dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--muted);
      animation: typingDots 1.3s infinite ease-in-out;
    }
    .typing .dot:nth-child(2) { animation-delay: 0.15s; }
    .typing .dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes typingDots {
      0%, 100% { transform: translateY(0); opacity: 0.6; }
      50% { transform: translateY(-3px); opacity: 1; }
    }

    /* Input area */
    .chat-inputs {
      display: grid;
      grid-template-columns: 38px 1fr 38px 38px 38px;
      gap: 8px;
      padding: var(--pad);
      border-top: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,31,63,0.55);
      backdrop-filter: blur(4px);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 40px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0, 43, 92, 0.65);
      color: var(--text);
      cursor: pointer;
      transition: all 0.18s ease;
    }
    .btn:hover { filter: brightness(1.12); }
    .btn.primary {
      background: linear-gradient(180deg, var(--accent-2), var(--accent));
      border-color: rgba(255,255,255,0.18);
      color: #00243f;
      box-shadow: var(--glow);
      font-weight: 700;
    }

    input#message-input {
      height: 40px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0, 43, 92, 0.65);
      color: var(--text);
      padding: 0 10px;
      outline: none;
      font-size: 14.5px;
      width: 100%;
    }
    input#message-input::placeholder { color: #96cad1; }

    /* Emoji/GIF/Sticker panels */
    .panel {
      position: absolute;
      bottom: 76px;
      right: 12px;
      width: 320px;
      max-height: 280px;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,31,63,0.85);
      backdrop-filter: blur(6px);
      box-shadow: var(--glow);
      display: none;
      z-index: 5;
    }
    .panel.show { display: block; }
    .panel-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px; font-size: 13px; color: var(--muted);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .panel-body { padding: 10px; overflow-y: auto; max-height: 230px; }

    /* Stickers grid */
    .stickers {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .sticker {
      width: 68px; height: 68px; border-radius: 10px;
      background: rgba(0,43,92,0.7); border: 1px solid rgba(255,255,255,0.08);
      display: grid; place-items: center; cursor: pointer;
    }
    .sticker img { width: 62px; height: 62px; object-fit: contain; border-radius: 8px; }

    /* Mobile optimization */
    @media (max-width: 640px) {
      #chat-bubble { bottom: 18px; right: 18px; }
      #chat-box {
        right: 0; bottom: 0;
        width: 100vw; height: 100vh; border-radius: 0;
      }
      .panel {
        right: 0; width: calc(100vw - 24px); bottom: 80px;
      }
      #companion { display: none; } /* Keep the focus on chat on smaller screens */
    }

    /* Accessible hide */
    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }
  </style>
</head>
<body>
  <!-- Ocean particles -->
  <canvas id="sea-particles"></canvas>

  <!-- Companion anime girl -->
  <img id="companion" src="assets/anime-girl.png" alt="Anime Companion">

  <!-- Companion dialogue container (injected dynamically) -->

  <!-- Floating chat bubble (minimized trigger) -->
  <div id="chat-bubble" title="Open Chat" aria-label="Open Chat">ðŸ’¬</div>

  <!-- Main chat box -->
  <section id="chat-box" class="hidden" aria-label="Shinkai Deep Sea Chat">
    <!-- Header -->
    <div class="chat-header">
      <div class="room-title">Shinkai Deep Sea â€¢ Private Room</div>
      <div class="presence">
        <span class="dot" aria-hidden="true"></span>
        <span id="presence-text">Connected</span>
      </div>
    </div>

    <!-- Messages -->
    <div id="messages" role="log" aria-live="polite" aria-relevant="additions"></div>

    <!-- Typing indicator -->
    <div class="typing" id="typing-indicator">
      <span>Typing</span>
      <div class="dots">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
    </div>

    <!-- Input area -->
    <div class="chat-inputs">
      <button class="btn" id="emoji-btn" title="Emoji" aria-label="Open Emoji Picker">ðŸ˜Š</button>
      <input id="message-input" placeholder="Type a message..." autocomplete="off" />
      <button class="btn" id="gif-btn" title="GIFs" aria-label="Open GIF Search">GIF</button>
      <button class="btn" id="sticker-btn" title="Stickers" aria-label="Open Stickers">ðŸŽ´</button>
      <button class="btn primary" id="send-btn" title="Send" aria-label="Send Message">Send</button>
    </div>

    <!-- Emoji picker panel -->
    <div class="panel" id="emoji-panel" role="dialog" aria-modal="false" aria-label="Emoji Picker">
      <div class="panel-header">
        <span>Emoji</span>
        <button class="btn" id="emoji-close" aria-label="Close Emoji">âœ•</button>
      </div>
      <div class="panel-body">
        <div id="emoji-picker"></div>
      </div>
    </div>

    <!-- GIF panel -->
    <div class="panel" id="gif-panel" role="dialog" aria-modal="false" aria-label="GIF Search">
      <div class="panel-header">
        <span>GIFs</span>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="gif-query" placeholder="Search GIPHYâ€¦" style="height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(0,43,92,0.65);color:var(--text);padding:0 8px;font-size:13px;">
          <button class="btn" id="gif-search" aria-label="Search GIFs">Search</button>
          <button class="btn" id="gif-close" aria-label="Close GIFs">âœ•</button>
        </div>
      </div>
      <div class="panel-body" id="gif-results" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;"></div>
    </div>

    <!-- Stickers panel -->
    <div class="panel" id="sticker-panel" role="dialog" aria-modal="false" aria-label="Stickers">
      <div class="panel-header">
        <span>Stickers</span>
        <button class="btn" id="sticker-close" aria-label="Close Stickers">âœ•</button>
      </div>
      <div class="panel-body">
        <div class="stickers" id="stickers-grid">
          <!-- Example stickers (replace with your own assets) -->
          <div class="sticker"><img src="assets/stickers/sakura.png" alt="Sakura"></div>
          <div class="sticker"><img src="assets/stickers/jellyfish.png" alt="Jellyfish"></div>
          <div class="sticker"><img src="assets/stickers/starry.png" alt="Starry"></div>
          <div class="sticker"><img src="assets/stickers/wave.png" alt="Wave"></div>
        </div>
      </div>
    </div>
  </section>

  <script>
    // Request notification permission early
    (async () => {
      if ('Notification' in window && Notification.permission !== 'granted') {
        try { await Notification.requestPermission(); } catch (e) {}
      }
    })();

    // Ocean particles animation
    (function initParticles(){
      const c = document.getElementById('sea-particles');
      const ctx = c.getContext('2d');
      let W, H, particles = [];

      function resize() {
        W = c.width = window.innerWidth;
        H = c.height = window.innerHeight;
      }
      window.addEventListener('resize', resize);
      resize();

      function spawn(n=60) {
        particles = Array.from({length:n}, () => ({
          x: Math.random()*W,
          y: Math.random()*H,
          r: Math.random()*2 + 0.6,
          o: Math.random()*0.7 + 0.2,
          vx: (Math.random()-0.5)*0.2,
          vy: (Math.random()-0.5)*0.3
        }));
      }
      spawn();

      function tick() {
        ctx.clearRect(0,0,W,H);
        for (const p of particles) {
          p.x += p.vx; p.y += p.vy;
          if (p.x < 0) p.x = W; if (p.x > W) p.x = 0;
          if (p.y < 0) p.y = H; if (p.y > H) p.y = 0;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
          ctx.fillStyle = `rgba(0, 188, 212, ${p.o})`;
          ctx.fill();
        }
        requestAnimationFrame(tick);
      }
      tick();
    })();

    // Chat panel toggling
    const chatBubble = document.getElementById('chat-bubble');
    const chatBox = document.getElementById('chat-box');
    chatBubble.addEventListener('click', () => {
      chatBox.classList.toggle('hidden');
    });

    // Companion dialogue
    function companionSpeak(text) {
      const bubble = document.createElement('div');
      bubble.className = 'companion-dialogue';
      bubble.textContent = text;
      document.body.appendChild(bubble);
      setTimeout(() => bubble.remove(), 4000);
    }

    // Panels toggling
    const emojiBtn = document.getElementById('emoji-btn');
    const gifBtn = document.getElementById('gif-btn');
    const stickerBtn = document.getElementById('sticker-btn');

    const emojiPanel = document.getElementById('emoji-panel');
    const gifPanel = document.getElementById('gif-panel');
    const stickerPanel = document.getElementById('sticker-panel');

    const emojiClose = document.getElementById('emoji-close');
    const gifClose = document.getElementById('gif-close');
    const stickerClose = document.getElementById('sticker-close');

    function closePanels() {
      emojiPanel.classList.remove('show');
      gifPanel.classList.remove('show');
      stickerPanel.classList.remove('show');
    }
    emojiBtn.addEventListener('click', () => {
      emojiPanel.classList.toggle('show'); gifPanel.classList.remove('show'); stickerPanel.classList.remove('show');
    });
    gifBtn.addEventListener('click', () => {
      gifPanel.classList.toggle('show'); emojiPanel.classList.remove('show'); stickerPanel.classList.remove('show');
    });
    stickerBtn.addEventListener('click', () => {
      stickerPanel.classList.toggle('show'); emojiPanel.classList.remove('show'); gifPanel.classList.remove('show');
    });
    [emojiClose, gifClose, stickerClose].forEach(btn => btn.addEventListener('click', closePanels));

    // Emoji picker init
    let emojiPickerMounted = false;
    document.addEventListener('DOMContentLoaded', () => {
      if (window.emojiMart && !emojiPickerMounted) {
        const { Picker } = window.emojiMart;
        const picker = new Picker({
          data: undefined, // uses default emoji dataset
          onEmojiSelect: (emoji) => {
            const input = document.getElementById('message-input');
            input.value += emoji.native || emoji.shortcodes || '';
            input.focus();
          },
          theme: 'dark'
        });
        document.getElementById('emoji-picker').appendChild(picker);
        emojiPickerMounted = true;
      }
    });

    // GIF search
    const gifQuery = document.getElementById('gif-query');
    const gifSearch = document.getElementById('gif-search');
    const gifResults = document.getElementById('gif-results');

    const GIPHY_KEY = 'YOUR_GIPHY_API_KEY'; // Replace if you want GIFs
    gifSearch.addEventListener('click', async () => {
      const q = gifQuery.value.trim();
      gifResults.innerHTML = '';
      if (!q) return;
      try {
        const res = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_KEY}&q=${encodeURIComponent(q)}&limit=12&rating=pg`);
        const data = await res.json();
        for (const g of data.data) {
          const url = g.images.fixed_height_small.url;
          const img = document.createElement('img');
          img.src = url; img.alt = g.title;
          img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover';
          const wrap = document.createElement('div');
          wrap.style.borderRadius = '10px';
          wrap.style.overflow = 'hidden';
          wrap.style.cursor = 'pointer';
          wrap.appendChild(img);
          wrap.onclick = () => sendMessage({ type: 'gif', url });
          gifResults.appendChild(wrap);
        }
      } catch (e) {
        companionSpeak('GIF sea currents are roughâ€”try again.');
      }
    });

    // Stickers send
    document.getElementById('stickers-grid').addEventListener('click', (e) => {
      const img = e.target.closest('.sticker')?.querySelector('img');
      if (!img) return;
      sendMessage({ type: 'sticker', url: img.src, alt: img.alt || 'Sticker' });
    });

    // Firebase setup (Compat for simplicity in single-file)
    window.addEventListener('load', () => {
      // Use your provided config here:
      const firebaseConfig = {
        apiKey: "AIzaSyBVVvi5Xxr-ypjQqV2p8XgcRsYtfsVmfts",
        authDomain: "anime-party-ab793.firebaseapp.com",
        databaseURL: "https://anime-party-ab793-default-rtdb.firebaseio.com",
        projectId: "anime-party-ab793",
        storageBucket: "anime-party-ab793.firebasestorage.app",
        messagingSenderId: "220188656976",
        appId: "1:220188656976:web:a699a028f1e9cd8bcdd855"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // Room path â€” you can customize for per-session rooms
      const ROOM_ID = 'andoru-shinkai-room';
      const messagesRef = db.ref(`rooms/${ROOM_ID}/messages`);
      const typingRefMe = db.ref(`rooms/${ROOM_ID}/typing/andoru`);
      const typingRefPartner = db.ref(`rooms/${ROOM_ID}/typing/partner`);
      const presenceText = document.getElementById('presence-text');
      const typingIndicator = document.getElementById('typing-indicator');

      // Presence (basic)
      presenceText.textContent = 'Connected';

      // Input and send
      const input = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-btn');

      // Typing indicator update with debounce
      let typingTimeout;
      input.addEventListener('input', () => {
        typingRefMe.set(true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => typingRefMe.set(false), 1200);
      });

      // Listen for partner typing
      typingRefPartner.on('value', (snap) => {
        const isTyping = !!snap.val();
        typingIndicator.classList.toggle('show', isTyping);
      });

      // Send message function (supports text/gif/sticker)
      function sendMessage(payload) {
        const base = {
          sender: 'Andoru Shinkai',
          timestamp: Date.now(),
          read: false
        };

        const msgObj = (payload && payload.type)
          ? { ...base, ...payload } // gif/sticker
          : { ...base, type: 'text', text: input.value.trim() };

        if (msgObj.type === 'text' && !msgObj.text) return;

        messagesRef.push(msgObj).then(() => {
          input.value = '';
          typingRefMe.set(false);
          if (Notification.permission === 'granted') {
            new Notification('Message sent', { body: msgObj.type === 'text' ? msgObj.text : msgObj.type.toUpperCase() });
          }
        }).catch(() => {
          companionSpeak('Message got tangled in the kelpâ€”try again.');
        });
      }

      // Send button
      sendBtn.addEventListener('click', () => sendMessage());

      // Enter to send
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendMessage();
        }
      });

      // Render incoming messages
      const messagesEl = document.getElementById('messages');

      function renderMessage(key, msg) {
        const wrap = document.createElement('div');
        wrap.className = 'msg' + (msg.sender === 'Andoru Shinkai' ? ' me' : '');
        // Content
        if (msg.type === 'text') {
          wrap.textContent = msg.text;
        } else if (msg.type === 'gif') {
          const img = document.createElement('img');
          img.src = msg.url; img.alt = 'GIF';
          img.style.maxWidth = '100%'; img.style.borderRadius = '8px';
          wrap.appendChild(img);
        } else if (msg.type === 'sticker') {
          const img = document.createElement('img');
          img.src = msg.url; img.alt = msg.alt || 'Sticker';
          img.style.maxWidth = '120px'; img.style.borderRadius = '8px';
          wrap.appendChild(img);
        }

        // Meta (timestamp + read status)
        const meta = document.createElement('div');
        meta.className = 'meta';
        const time = document.createElement('span');
        time.textContent = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const status = document.createElement('span');
        status.className = msg.read ? 'status-read' : 'status-unread';
        status.textContent = msg.read ? 'Read' : 'Sent';
        meta.appendChild(time);
        meta.appendChild(status);
        wrap.appendChild(meta);

        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;

        // Companion reacts to partner messages
        if (msg.sender !== 'Andoru Shinkai') {
          companionSpeak('She replied! Ganbatte, Andoru!');
          if (Notification.permission === 'granted') {
            new Notification(`New message from ${msg.sender}`, {
              body: msg.type === 'text' ? msg.text : msg.type.toUpperCase()
            });
          }
        }
      }

      // Listen to new messages
      messagesRef.on('child_added', (snap) => {
        const key = snap.key;
        const msg = snap.val();
        renderMessage(key, msg);

        // Auto-mark partner messages as read once rendered in view
        if (msg.sender !== 'Andoru Shinkai' && !msg.read) {
          db.ref(`rooms/${ROOM_ID}/messages/${key}/read`).set(true);
        }
      });
    });

    // Close panels when clicking outside
    document.addEventListener('click', (e) => {
      const withinPanel = e.target.closest('.panel');
      const isToggleBtn = e.target.closest('#emoji-btn,#gif-btn,#sticker-btn');
      if (!withinPanel && !isToggleBtn) {
        const openPanels = document.querySelectorAll('.panel.show');
        openPanels.forEach(p => p.classList.remove('show'));
      }
    });
  </script>
</body>
</html>