<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Anime Party — Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0d0d0f; --panel:#16161a; --text:#fff; --muted:#a1a1aa;
      --accent:#ff4fd8; --border:#23232a;
    }
    *{ box-sizing:border-box; }
    body{ font-family:Poppins,system-ui; background:#0d0d0f; color:var(--text); margin:0; }
    .site-header{ background:#18181b; border-bottom:1px solid var(--border); padding:14px 22px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; }
    .logo-wrap{ display:flex; align-items:center; gap:10px; }
    .logo{ height:36px; width:36px; border-radius:8px; background:#222; }
    .brand{ font-weight:700; }
    .nav a{ color:var(--muted); margin-left:16px; text-decoration:none; }
    .nav a.active, .nav a:hover{ color:var(--accent); }
    .container{ max-width:1100px; margin:26px auto; padding:0 16px; }
    .grid{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media(min-width:1024px){ .grid{ grid-template-columns:2fr 1fr; } }
    .card{ background:#131317; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .card-header{ padding:14px 16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); }
    .badge{ padding:6px 10px; border-radius:999px; background:#232329; border:1px solid var(--border); color:#d4d4d8; font-size:.85rem; }
    .player-wrap{ position:relative; background:#000; }
    video{ width:100%; aspect-ratio:16/9; display:block; background:#000; }
    .overlay{ position:absolute; inset:0; background:#000; color:#fff; display:flex; align-items:center; justify-content:center; text-align:center; padding:24px; }
    .overlay.hidden{ display:none; }
    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; }
    .chat-box{ background:#101014; border:1px solid var(--border); border-radius:8px; height:260px; overflow-y:auto; padding:10px; margin-bottom:10px; font-size:.95rem; }
    .chat-msg{ margin:6px 0; }
    .row{ display:flex; gap:8px; }
    .input{ flex:1; background:#101014; color:#fff; border:1px solid var(--border); border-radius:8px; padding:10px; }
    .btn{ background:var(--accent); color:#fff; border:none; border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer; }
    .btn.secondary{ background:#2a2a32; }
    .site-footer{ margin:30px auto 40px; max-width:1100px; padding:0 16px; color:var(--muted); text-align:center; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="logo-wrap">
      <div class="logo"></div>
      <div>
        <div class="brand">Anime Party</div>
        <div style="color:#a1a1aa;font-size:.9rem;">Watch together, your way</div>
      </div>
    </div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="room.html" class="active">Room</a>
      <a href="#">Library</a>
      <a href="#">Profile</a>
    </nav>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Player -->
      <section class="card">
        <div class="card-header">
          <div>Now Playing</div>
          <div class="badge" id="roleBadge">Role: —</div>
        </div>
        <div class="player-wrap">
          <div id="guestOverlay" class="overlay">Loading next anime… The host will start the episode shortly.</div>
          <video id="video" controls>
            <source id="videoSrc" src="assets/sample.mp4" type="video/mp4" />
          </video>
        </div>
      </section>

      <!-- Chat panel -->
      <aside class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-weight:600;">Chat</div>
          <div class="badge" id="roomBadge">Room: —</div>
        </div>

        <div id="chatBox" class="chat-box"></div>
        <div class="row">
          <input id="chatInput" class="input" placeholder="Type a message…" />
          <button class="btn" id="sendBtn">Send</button>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn secondary" id="claimHostBtn">Claim host</button>
          <button class="btn secondary" id="toggleOverlayBtn">Toggle guest loading</button>
        </div>

        <div id="status" style="color:#a1a1aa;margin-top:8px;font-size:.9rem;">Status: Connecting…</div>
      </aside>
    </div>
  </div>

  <div class="site-footer">&copy; 2025 Anime Party. All rights reserved.</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, push, onChildAdded, onValue, update } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // TODO: replace with your config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Parse URL params: roomId and name
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get("roomId");
    const myName = params.get("name") || "Guest";

    const roleBadge = document.getElementById("roleBadge");
    const roomBadge = document.getElementById("roomBadge");
    const statusEl = document.getElementById("status");
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const claimHostBtn = document.getElementById("claimHostBtn");
    const toggleOverlayBtn = document.getElementById("toggleOverlayBtn");

    const guestOverlay = document.getElementById("guestOverlay");

    let isHost = false;

    // Update status
    function status(text){ statusEl.textContent = "Status: " + text; }

    // Display chat message
    function displayMessage(sender, text){
      const p = document.createElement("p");
      p.className = "chat-msg";
      p.textContent = sender + ": " + text;
      chatBox.appendChild(p);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Create basic presence (first to claim host becomes host)
    async function initRoom(){
      if (!roomId) { status("Missing roomId. Return to Home."); return; }
      roomBadge.textContent = "Room: " + roomId;

      // If no host exists, show claim button; else read who host is.
      const hostRef = ref(db, `rooms/${roomId}/meta/host`);
      onValue(hostRef, (snap) => {
        const hostName = snap.val();
        if (!hostName){
          roleBadge.textContent = "Role: Guest (no host yet)";
          isHost = false;
        } else {
          isHost = (hostName === myName);
          roleBadge.textContent = "Role: " + (isHost ? "Host" : "Guest");
        }
      });

      // Overlay visibility — guests see it on until host toggles
      const overlayRef = ref(db, `rooms/${roomId}/meta/overlayVisible`);
      onValue(overlayRef, (snap) => {
        const visible = snap.val();
        if (visible === false) guestOverlay.classList.add("hidden");
        else guestOverlay.classList.remove("hidden");
      });

      // Listen for chat
      const chatRef = ref(db, `rooms/${roomId}/chat`);
      onChildAdded(chatRef, (snapshot) => {
        const msg = snapshot.val();
        displayMessage(msg.sender, msg.text);
      });

      status("Connected");
    }

    // Send chat
    async function sendChat(){
      const text = chatInput.value.trim();
      if (!text) return;
      chatInput.value = "";
      const msgRef = push(ref(db, `rooms/${roomId}/chat`));
      await set(msgRef, { sender: myName, text, timestamp: Date.now() });
    }

    // Claim host
    async function claimHost(){
      await update(ref(db, `rooms/${roomId}/meta`), { host: myName, overlayVisible: true });
      isHost = true;
      roleBadge.textContent = "Role: Host";
      status("You are now the host.");
    }

    // Toggle guest overlay (host only)
    async function toggleOverlay(){
      if (!isHost){ status("Only host can toggle overlay."); return; }
      const overlayRef = ref(db, `rooms/${roomId}/meta/overlayVisible`);
      let current;
      await onValue(overlayRef, (snap) => { current = snap.val(); }, { onlyOnce:true });
      const next = !current;
      await update(ref(db, `rooms/${roomId}/meta`), { overlayVisible: next });
      status("Guest overlay: " + (next ? "ON (loading)" : "OFF (visible)"));
    }

    // Wire buttons
    sendBtn.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendChat(); });
    claimHostBtn.addEventListener("click", claimHost);
    toggleOverlayBtn.addEventListener("click", toggleOverlay);

    initRoom();
  </script>
</body>
</html>